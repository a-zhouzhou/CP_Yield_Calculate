<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>多项目计算器</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 10px; text-align: center; }
    input { width: 80px; padding: 4px; text-align: center; }
    button { margin-top: 20px; padding: 10px 20px; font-size: 16px; }
    .result-cell { background-color: #f0f8ff; font-weight: bold; }
    #loading { color: #666; }
  </style>
</head>
<body>
  <h2>多项目参数计算表</h2>
  <div id="loading">加载项目中...</div>
  <table id="calcTable" style="display:none;">
    <thead><tr><th>参数/结果</th></tr></thead>
    <tbody>
      <tr><td>参数1</td></tr>
      <tr><td>参数2</td></tr>
      <tr><td>参数3</td></tr>
      <tr><td>参数4</td></tr>
      <tr><td>参数5</td></tr>
      <tr><td>参数6</td></tr>
      <tr><td>结果1</td></tr>
      <tr><td>结果2</td></tr>
    </tbody>
  </table>
  <button id="calcBtn" style="display:none;" onclick="calculateAll()">计算所有项目</button>

  <script>
    let PROJECTS = {}; // 动态加载

    // 1. 从后端获取项目列表
    async function loadProjects() {
      try {
        const res = await fetch('/api/projects');
        const data = await res.json();
        PROJECTS = data.projects; // { "proj_id": "项目名" }
        renderTable();
      } catch (err) {
        document.getElementById('loading').textContent = '加载失败，请刷新';
      }
    }

    // 2. 动态渲染表格
    function renderTable() {
      const thead = document.querySelector('#calcTable thead tr');
      const tbody = document.querySelector('#calcTable tbody');

      // 清空可能的旧列（防止重复）
      thead.querySelectorAll('th:not(:first-child)').forEach(el => el.remove());
      tbody.querySelectorAll('td').forEach(el => el.remove());

      // 添加项目列头
      Object.values(PROJECTS).forEach(name => {
        const th = document.createElement('th');
        th.textContent = name;
        thead.appendChild(th);
      });

      // 为每一行添加单元格
      const rows = tbody.querySelectorAll('tr');
      rows.forEach((row, rowIndex) => {
        Object.keys(PROJECTS).forEach(projId => {
          const cell = document.createElement('td');
          if (rowIndex < 6) {
            const input = document.createElement('input');
            input.type = 'number';
            input.step = '0.01';
            input.dataset.proj = projId;
            input.dataset.row = rowIndex;
            cell.appendChild(input);
          } else {
            cell.classList.add('result-cell');
            cell.id = `result-${projId}-${rowIndex - 6}`;
          }
          row.appendChild(cell);
        });
      });

      // 显示表格
      document.getElementById('loading').style.display = 'none';
      document.getElementById('calcTable').style.display = '';
      document.getElementById('calcBtn').style.display = '';
    }

    // 3. 计算函数（不变）
    async function calculateAll() {
      const inputs = {};
      Object.keys(PROJECTS).forEach(projId => {
        inputs[projId] = [];
        for (let i = 0; i < 6; i++) {
          const input = document.querySelector(`input[data-proj="${projId}"][data-row="${i}"]`);
          const val = parseFloat(input.value);
          inputs[projId].push(isNaN(val) ? 0 : val);
        }
      });

      try {
        const res = await fetch('/api/calculate', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ inputs })
        });
        const data = await res.json();

        if (data.error) {
          alert('错误: ' + data.error);
          return;
        }

        Object.entries(data.results).forEach(([projId, results]) => {
          results.forEach((value, idx) => {
            const cell = document.getElementById(`result-${projId}-${idx}`);
            if (cell) cell.textContent = value;
          });
        });
      } catch (err) {
        alert('网络错误');
      }
    }

    // 启动
    loadProjects();
  </script>
</body>
</html>
 
